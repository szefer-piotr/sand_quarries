# Facet plot ----
facet_dat <-data.frame(
val = c(log(desasc$abun+1),
desasc$rich,
desasc$sw),
group = rep(desasc$group,3),
stage = rep(desasc$succession, 3),
type = rep(c("No. of individuals",
"Richness",
"Diversity"), each=96)
)
facet_dat$fsucc <- 0
facet_dat[facet_dat$stage == 1,]$fsucc <- "Stage I"
facet_dat[facet_dat$stage == 2,]$fsucc <- "Stage II"
facet_dat[facet_dat$stage == 3,]$fsucc <- "Stage III"
facet_dat$int <- as.character(desasc$GS)
facet_dat$type <- as.character(facet_dat$type)
facet_dat$post_hoc <- "x"
# Generate labels
# For "No. of individuals"
abugroups <- data.frame(int = phabu$GS,
gr = gsub(" ", "", phabu$.group))
abugroups$gr <- as.character(abugroups$gr)
for (itr in abugroups$int){
indices <- (facet_dat$type == "No. of individuals" & facet_dat$int == itr)
facet_dat[indices,]$post_hoc <- abugroups[abugroups$int == itr,]$gr
}
# For "Diversity"
divgroups <- data.frame(int = phsw$GS,
gr = gsub(" ", "", phsw$.group))
divgroups$gr <- as.character(divgroups$gr)
for (itr in divgroups$int){
indices <- (facet_dat$type == "Diversity" & facet_dat$int == itr)
facet_dat[indices,]$post_hoc <- divgroups[divgroups$int == itr,]$gr
}
# For "Richness"
richgroups <- data.frame(int = phrich$GS,
gr = gsub(" ", "", phrich$.group))
richgroups$gr <- as.character(richgroups$gr)
for (itr in richgroups$int){
indices <- (facet_dat$type == "Richness" & facet_dat$int == itr)
facet_dat[indices,]$post_hoc <- richgroups[richgroups$int == itr,]$gr
}
facet_dat
# Rare species analysis
source("data/data_processing.R")
# library(brms)
# library(lme4)
# library(lmerTest)
# Estimating probability of obtaining vulnerable individual
raredf$fStage <- "Early"
raredf[raredf$stage == 2, ]$fStage <- "Mid"
raredf[raredf$stage == 3, ]$fStage <- "Late"
raredf$vuln <- raredf$vuln == 1
raredf$lifeh <- factor(raredf$lifeh, levels = c('herbivore',
'kleptoparasite',
'predator'),
labels = c('Herbivore',
'Kleptoparasite',
'Predator'))
# Bayesian model
# vulsp0c <- brm(vuln ~ lifeh*fStage,
#                data = raredf,
#                family = 'bernoulli',
#                prior = set_prior("uniform(2,4)", lb = 2, ub = 4),
#                iter = 1000,
#                chains = 4)
# Ordinary glm
library(emmeans)
library(multcomp)
glm0 <- (glm(vuln ~ fStage,
family = binomial(link = "logit"),
data =raredf))
summary(glm0)
glm1 <- (glm(vuln ~ lifeh*fStage,
family = binomial(link = "logit"),
data =raredf))
raredf$lifeStage <- paste(raredf$lifeh, raredf$fStage, sep="_")
# Same model but formatted specifically for pairwise comparisons
glm2 <- glm(vuln ~ lifeStage,
family = binomial(link = "logit"),
data =raredf)
it2 <- emmeans(glm2, "lifeStage")
it2let <- cld(it2, Letter="abcdefghijklm")
ltrs <- c(it2let$.group[3],
it2let$.group[6],
it2let$.group[2],
it2let$.group[4],
it2let$.group[5],
it2let$.group[7],
it2let$.group[1],
it2let$.group[8],
it2let$.group[9])
ltrs <- gsub(" ", "", ltrs)
# Predict the data and prepare plots
it1 <- emmeans(glm1, pairwise~ fStage|lifeh )
as.data.frame(it1$contrasts)
rarespdf <- as.data.frame(it1$emmeans)
newdat <- expand.grid(fStage = c("Early",
"Mid",
"Late"),
lifeh = c("Herbivore",
"Kleptoparasite",
"Predator"
))
newdata.pred = predict(glm1, type = "response",
newdata = newdat,se.fit = T,
interval = "confidence")
newdata.pred0 = predict(glm0, type = "response",
newdata = newdat,se.fit = T,
interval = "confidence")
newdata.pred
table(raredf$lifeh, raredf$fStage)
plotdat <- data.frame(Stage = newdat$fStage,
Group = newdat$lifeh,
Proportion = newdata.pred$fit,
N = as.vector(t(table(raredf$lifeh, raredf$fStage))),
SE = newdata.pred$se.fit,
CLR = rep(colvec[3:5], each=3),
sig = ltrs)
#Lower limit = p - (z) (Estimated σp) - 0.5/N
plotdat$ucl <- plotdat$Proportion + qnorm(0.975)*plotdat$SE - 0.5/plotdat$N
plotdat$lcl <- plotdat$Proportion - qnorm(0.975)*plotdat$SE - 0.5/plotdat$N
# General proportion for stages ----
it0 <- emmeans(glm0, "fStage")
it0let <- cld(it0, Letter="abcdefghijklm")
newdat0 <- expand.grid(fStage = c("Early",
"Mid",
"Late"))
newdata.pred0 = predict(glm0, type = "response",
newdata = newdat0,se.fit = T,
interval = "confidence")
plotdat0 <- data.frame(Stage = newdat0$fStage,
Proportion = newdata.pred0$fit,
N = as.vector(t(table(raredf$fStage))),
SE = newdata.pred0$se.fit,
CLR = colvec[3:5],
sig = it0let$.group)
#Lower limit = p - (z) (Estimated σp) - 0.5/N
plotdat0$ucl <- plotdat0$Proportion + qnorm(0.975)*plotdat0$SE - 0.5/plotdat0$N
plotdat0$lcl <- plotdat0$Proportion - qnorm(0.975)*plotdat0$SE - 0.5/plotdat0$N
p<- ggplot(plotdat0, aes(x=Stage, y=Proportion,
label = sig)) +
geom_point(size=3)+
geom_errorbar(aes(ymin=lcl,
ymax=ucl), width=.2,lwd=1,
position=position_dodge(0.05))+
stat_summary(fun=mean, geom="text",
col = rgb(10,10,10,180,maxColorValue = 255),
hjust = 1.7)+
ylim(0, 0.21)
# jpeg("fig_4_rare_species.jpg", width = 800, height = 300)
p+ theme_bw()+ theme(legend.position = "none")+
# jpeg("fig_4_rare_species.jpg", width = 800, height = 300)
p+ theme_bw()+ theme(legend.position = "none")
anova(glm0)
summary(glm0)
glmNULL <- (glm(vuln ~ 1,
family = binomial(link = "logit"),
data =raredf))
glm0 <- (glm(vuln ~ fStage,
family = binomial(link = "logit"),
data =raredf))
anova(glmNULL, glm0)
anova(glmNULL, glm0, test = "Chi")
# Source data processing script ----
source("data/data_processing.R")
library(vegan)
# Transformation
ascnt <- asc
asc <- decostand(asc, "hel")
# 1. RDA ordination ----
rda1 <- rda(asc~as.factor(succession), data=stages)
rdaa <- rda(asc[,groups=="Herbivores"]~as.factor(succession), data=stages)
rdas <- rda(asc[,groups=="Predators"]~as.factor(succession), data=stages)
rdac <- rda(asc[,groups=="Kleptoparasites"]~as.factor(succession), data=stages)
# m <- cca1
m <- rda1
#>>> Statistical test ----
anova(m, by="terms", permutations = 999)
anova(m, by="axis", permutations = 999)
# >>> R2 -----
coef(m)
R2 <- RsquareAdj(m)$r.squared
R2
# 2. Variance explained -----
sumeig <- summary(eigenvals(m))
round(sumeig[2,1],3)
round(sumeig[2,2],3)
# Fit species onto ordination
set.seed(1234)
gps <- data.frame(Species = colnames(asc), Group = groups)
spc <- envfit(m, asc, permutations = 9999)
spcdf <- data.frame(Spec = names(spc$vectors$pvals),
R = spc$vectors$r,
Pvals = spc$vectors$pvals,
gps[names(spc$vectors$pvals), ]$Group)
# withouth selection
as.factor(groups)
names(summary(rda1))
which(colnames(asc) == rownames(summary(rda1)$species))
make_rda_plot <- function(m, scl=3, type = "Apiformes", color){
plot(m, type = "n", scaling = scl,
xlab = paste("RDA1 [",
round(sumeig[2,1]*100,2),
"%]",
sep=""),
ylab = paste("RDA2 [",
round(sumeig[2,2]*100,2),
"%]",
sep=""),
cex.lab = 1.5)
points(m, display = "species",
col = colvec[color],
scaling = scl, pch=19, cex = 1.5,
select = colnames(asc[groups == type]))
points(m, display="cn", scaling = scl,
col = "red",
pch = 25)
text(m, display="cn", scaling = scl,
labels = c("Early",
"Mid",
"Late"),
col = "red", lwd=1.5,
pos = 3)
grnames <- colnames(asc[,groups == type])
lgn <- length(selected_gof[selected_gof %in% grnames])
if(lgn != 0){
text(m, display="species", scaling=scl,
select = selected_gof[selected_gof %in% grnames],
col=cgray)
}
}
# pdf("fig2_rda.pdf", width = 12, height = 4)
par(mfrow = c(1,3))
make_rda_plot(m, 3, "Herbivores", 1)
make_rda_plot(m, 3, "Predators", 3)
make_rda_plot(m, 3, "Kleptoparasites", 2)
efs <- names(spc$vectors$pvals[spc$vectors$pvals <= 0.05])
rownames(gps) <- gps[,1]
gps$Significance <- "NS"
# gps[!(rownames(gps) %in% efs), ]$ns <- "NS"
gps[efs,]$Significance <- "SI"
Ag.3.5raw <- table(gps$Group,  gps$Significance)
# gps[!(rownames(gps) %in% efs), ]$ns <- "NS"
gps[efs,]$Significance <- "SI"
Ag.3.5raw <- table(gps$Group,  gps$Significance)
Ag.3.5raw
source("data/data_processing.R")
library(labdsv)
set.seed(123)
# Indicator values
ivs <- indval(asc, clustering = stages$succession, numitr = 9999)
dfr <-data.frame(Cluster = ivs$maxcls,
IndicatorValue = ivs$indcls,
Probability = ivs$pval)
dfr <- dfr[dfr$Probability <= 0.05,]
dfr <- dfr[order(dfr$Cluster), ]
dfr <- with(dfr, dfr[order(-Cluster, IndicatorValue, decreasing = TRUE),])
# Contingency table
gps <- cbind(colnames(asc),groups)
rownames(gps) <- gps[,1]
dfr$group <- gps[rownames(dfr),2]
ct <- table(dfr$Cluster, dfr$group)
rownames(ct) <- c("SI","SII","SIII")
# Indicator species for trophic groups
ivtable.entries <- c(ct[1,],  ct[2,],  ct[3,])
ivtable <- t(as.table(matrix(ivtable.entries, nrow = 3, byrow = TRUE, dimnames = list(Stage = c('Early', 'Mid', 'Late'), Group = c('Herb', 'Klep', 'Pred')))))
addmargins(ivtable)
# Ind val
source("data/data_processing.R")
library(labdsv)
set.seed(123)
# Indicator values
ivs <- indval(asc, clustering = stages$succession, numitr = 9999)
dfr <-data.frame(Cluster = ivs$maxcls,
IndicatorValue = ivs$indcls,
Probability = ivs$pval)
dfr <- dfr[dfr$Probability <= 0.05,]
dfr <- dfr[order(dfr$Cluster), ]
dfr <- with(dfr, dfr[order(-Cluster, IndicatorValue, decreasing = TRUE),])
# Contingency table
gps <- cbind(colnames(asc),groups)
rownames(gps) <- gps[,1]
dfr$group <- gps[rownames(dfr),2]
ct <- table(dfr$Cluster, dfr$group)
rownames(ct) <- c("SI","SII","SIII")
# Decomposition of 3x3 contingency table ----
# Indicator species for trophic groups
ivtable.entries <- c(ct[1,],  ct[2,],  ct[3,])
ivtable <- t(as.table(matrix(ivtable.entries, nrow = 3, byrow = TRUE, dimnames = list(Stage = c('Early', 'Mid', 'Late'), Group = c('Herb', 'Klep', 'Pred')))))
addmargins(ivtable)
source("data/data_processing.R")
# Estimating probability of obtaining vulnerable individual
raredf$fStage <- "Early"
raredf[raredf$stage == 2, ]$fStage <- "Mid"
raredf[raredf$stage == 3, ]$fStage <- "Late"
raredf$vuln <- raredf$vuln == 1
raredf$lifeh <- factor(raredf$lifeh, levels = c('herbivore',
'kleptoparasite',
'predator'),
labels = c('Herbivore',
'Kleptoparasite',
'Predator'))
raredf$lifeh <- factor(raredf$lifeh, levels = c('herbivore',
'kleptoparasite',
'predator'),
labels = c('Herbivores',
'Kleptoparasites',
'Predators'))
# Rare species analysis
source("data/data_processing.R")
# library(brms)
# library(lme4)
# library(lmerTest)
# Estimating probability of obtaining vulnerable individual
raredf$fStage <- "Early"
raredf[raredf$stage == 2, ]$fStage <- "Mid"
raredf[raredf$stage == 3, ]$fStage <- "Late"
raredf$vuln <- raredf$vuln == 1
raredf$lifeh <- factor(raredf$lifeh, levels = c('herbivore',
'kleptoparasite',
'predator'),
labels = c('Herbivores',
'Kleptoparasites',
'Predators'))
# Ordinary glm
library(emmeans)
library(multcomp)
glmNULL <- (glm(vuln ~ 1,
family = binomial(link = "logit"),
data =raredf))
glm0 <- (glm(vuln ~ fStage,
family = binomial(link = "logit"),
data =raredf))
summary(glm0)
anova(glmNULL, glm0, test = "Chi")
glm1 <- (glm(vuln ~ lifeh*fStage,
family = binomial(link = "logit"),
data =raredf))
raredf$lifeStage <- paste(raredf$lifeh, raredf$fStage, sep="_")
# Same model but formatted specifically for pairwise comparisons
glm2 <- glm(vuln ~ lifeStage,
family = binomial(link = "logit"),
data =raredf)
it2 <- emmeans(glm2, "lifeStage")
it2let <- cld(it2, Letter="abcdefghijklm")
ltrs <- c(it2let$.group[3],
it2let$.group[6],
it2let$.group[2],
it2let$.group[4],
it2let$.group[5],
it2let$.group[7],
it2let$.group[1],
it2let$.group[8],
it2let$.group[9])
ltrs <- gsub(" ", "", ltrs)
# Predict the data and prepare plots
it1 <- emmeans(glm1, pairwise~ fStage|lifeh )
as.data.frame(it1$contrasts)
rarespdf <- as.data.frame(it1$emmeans)
newdat <- expand.grid(fStage = c("Early",
"Mid",
"Late"),
lifeh = c("Herbivore",
"Kleptoparasite",
"Predator"
))
newdata.pred = predict(glm1, type = "response",
newdata = newdat,se.fit = T,
interval = "confidence")
newdata.pred0 = predict(glm0, type = "response",
newdata = newdat,se.fit = T,
interval = "confidence")
newdata.pred
table(raredf$lifeh, raredf$fStage)
plotdat <- data.frame(Stage = newdat$fStage,
Group = newdat$lifeh,
Proportion = newdata.pred$fit,
N = as.vector(t(table(raredf$lifeh, raredf$fStage))),
SE = newdata.pred$se.fit,
CLR = rep(colvec[3:5], each=3),
sig = ltrs)
#Lower limit = p - (z) (Estimated σp) - 0.5/N
plotdat$ucl <- plotdat$Proportion + qnorm(0.975)*plotdat$SE - 0.5/plotdat$N
plotdat$lcl <- plotdat$Proportion - qnorm(0.975)*plotdat$SE - 0.5/plotdat$N
p<- ggplot(plotdat, aes(x=Stage, y=Proportion,
group = Group,
color = Group,
label = sig)) +
geom_point(size=3)+
geom_errorbar(aes(ymin=lcl,
ymax=ucl), width=.2,lwd=1,
position=position_dodge(0.05))+
stat_summary(fun=mean, geom="text",
col = rgb(10,10,10,180,maxColorValue = 255),
hjust = 1.7)+
facet_wrap(~Group)+
ylim(0, 0.21)
source("data/data_processing.R")
# Estimating probability of obtaining vulnerable individual
raredf$fStage <- "Early"
raredf[raredf$stage == 2, ]$fStage <- "Mid"
raredf[raredf$stage == 3, ]$fStage <- "Late"
raredf$vuln <- raredf$vuln == 1
raredf$lifeh <- factor(raredf$lifeh, levels = c('herbivore',
'kleptoparasite',
'predator'),
labels = c('Herbivores',
'Kleptoparasites',
'Predators'))
# Ordinary glm
library(emmeans)
library(multcomp)
glmNULL <- (glm(vuln ~ 1,
family = binomial(link = "logit"),
data =raredf))
glm0 <- (glm(vuln ~ fStage,
family = binomial(link = "logit"),
data =raredf))
summary(glm0)
anova(glmNULL, glm0, test = "Chi")
glm1 <- (glm(vuln ~ lifeh*fStage,
family = binomial(link = "logit"),
data =raredf))
raredf$lifeStage <- paste(raredf$lifeh, raredf$fStage, sep="_")
# Same model but formatted specifically for pairwise comparisons
glm2 <- glm(vuln ~ lifeStage,
family = binomial(link = "logit"),
data =raredf)
it2 <- emmeans(glm2, "lifeStage")
it2let <- cld(it2, Letter="abcdefghijklm")
ltrs <- c(it2let$.group[3],
it2let$.group[6],
it2let$.group[2],
it2let$.group[4],
it2let$.group[5],
it2let$.group[7],
it2let$.group[1],
it2let$.group[8],
it2let$.group[9])
ltrs <- gsub(" ", "", ltrs)
# Predict the data and prepare plots
it1 <- emmeans(glm1, pairwise~ fStage|lifeh )
as.data.frame(it1$contrasts)
rarespdf <- as.data.frame(it1$emmeans)
newdat <- expand.grid(fStage = c("Early",
"Mid",
"Late"),
lifeh = c("Herbivore",
"Kleptoparasite",
"Predator"
))
newdata.pred = predict(glm1, type = "response",
newdata = newdat,se.fit = T,
interval = "confidence")
newdat <- expand.grid(fStage = c("Early",
"Mid",
"Late"),
lifeh = c("Herbivores",
"Kleptoparasites",
"Predators"
))
newdata.pred = predict(glm1, type = "response",
newdata = newdat,se.fit = T,
interval = "confidence")
newdata.pred0 = predict(glm0, type = "response",
newdata = newdat,se.fit = T,
interval = "confidence")
newdata.pred
table(raredf$lifeh, raredf$fStage)
plotdat <- data.frame(Stage = newdat$fStage,
Group = newdat$lifeh,
Proportion = newdata.pred$fit,
N = as.vector(t(table(raredf$lifeh, raredf$fStage))),
SE = newdata.pred$se.fit,
CLR = rep(colvec[3:5], each=3),
sig = ltrs)
#Lower limit = p - (z) (Estimated σp) - 0.5/N
plotdat$ucl <- plotdat$Proportion + qnorm(0.975)*plotdat$SE - 0.5/plotdat$N
plotdat$lcl <- plotdat$Proportion - qnorm(0.975)*plotdat$SE - 0.5/plotdat$N
p<- ggplot(plotdat, aes(x=Stage, y=Proportion,
group = Group,
color = Group,
label = sig)) +
geom_point(size=3)+
geom_errorbar(aes(ymin=lcl,
ymax=ucl), width=.2,lwd=1,
position=position_dodge(0.05))+
stat_summary(fun=mean, geom="text",
col = rgb(10,10,10,180,maxColorValue = 255),
hjust = 1.7)+
facet_wrap(~Group)+
ylim(0, 0.21)
jpeg("fig_4_rare_species_v2.jpg", width = 800, height = 300)
p+ theme_bw()+ theme(legend.position = "none")+
scale_color_manual(values=c(alpha(colvec[2],1),
alpha(colvec[1],1),
alpha(colvec[3],1)))
dev.off()
# Source data processing script ----
source("data/data_processing.R")
# library(nlme)
library(MASS)
library(emmeans)
library(multcomp)
# General model
abund_gen <- glm.nb(abun~1+succession, data = desasc)
anova(abund_gen, test = "Chi")
inter.test_gen <- emmeans(abund_gen, "succession")
phabu_gen <- cld(inter.test_gen, Letter="abcdefghijklm")
desasc
